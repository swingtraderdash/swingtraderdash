<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SwingTrader - Watchlist</title>
  <link rel="stylesheet" href="/css/main.css" />
  <style>
    .ticker-entry {
      margin-bottom: 10px;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .ticker-entry strong {
      color: #333;
    }
    .ticker-remove {
      margin-left: 10px;
      color: red;
      cursor: pointer;
    }
    .modal {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -30%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 3000 !important;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      text-align: center;
    }
    .modal button {
      margin-right: 10px;
      margin-top: 10px;
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .modal button:hover {
      background: #2980b9;
    }
    .modal #ok-btn {
      margin-right: 0;
      display: block;
      margin: 10px auto 0;
      width: auto;
    }
    .ticker-count {
      margin-bottom: 10px;
      font-size: 1.2rem;
      color: #008000;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #modal-container {
      display: none !important;
    }
    #modal-container.show {
      display: block !important;
    }
  </style>
  <script type="module" src="/js/firebaseConfig.js" defer></script>
  <script type="module" src="/js/main.js" defer></script>
  <script type="module" src="/js/injectNav.js" defer></script>
</head>
<body>
  <div id="nav"></div>
  <main class="main">
    <div class="container">
      <section class="page-content">
        <h2>Watchlist</h2>

        <div class="watchlist-input">
          <form id="ticker-form" method="POST">
            <div class="form-group">
              <textarea 
                id="ticker-input" 
                name="tickers" 
                rows="3" 
                placeholder="AAPL, GOOGL, MSFT, TSLA..."
                maxlength="2000">
              </textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="add-button">Add to Watchlist</button>
          </form>
          <div id="feedback" style="color: red; margin-top: 10px;"></div>
        </div>

        <div class="watchlist-display">
          <div id="ticker-list">
            <!-- Tickers will be displayed here -->
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 SwingTrader. All rights reserved.</p>
    </div>
  </footer>

  <button id="test-spinner">Test Spinner</button>
  <div id="modal-container" style="display:none;"></div>
  <script type="module">
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { saveWatchlist, getWatchlist, fetchMetadataForTickers } from '/js/storage.js';
    import { injectNav } from "/js/injectNav.js";
    import { app } from "/js/firebaseConfig.js";

    injectNav();

    const auth = getAuth();
    const db = getFirestore(app);

    function showModal(message, onConfirm, onCancel) {
      console.log("üì∏ Showing modal with message:", message);
      const modalContainer = document.getElementById('modal-container');
      if (!modalContainer) {
        console.error("‚ùå Modal container not found!");
        const newContainer = document.createElement('div');
        newContainer.id = 'modal-container';
        newContainer.style.display = 'none';
        document.body.appendChild(newContainer);
        console.log("üì∏ Created new modal-container");
        return showModal(message, onConfirm, onCancel);
      }
      modalContainer.innerHTML = `
        <div class="modal">
          <p style="white-space: pre-line;">${message}</p>
          <button id="confirm-btn">Confirm</button>
          <button id="cancel-btn">Cancel</button>
        </div>
      `;
      modalContainer.classList.add('show');
      console.log("üì∏ Modal container class set to show");

      const confirmBtn = document.getElementById('confirm-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      if (!confirmBtn || !cancelBtn) {
        console.error("‚ùå Confirm or Cancel button not found!");
        return;
      }
      console.log("üì∏ Binding confirm button listener");
      confirmBtn.addEventListener('click', () => {
        console.log("‚úÖ Confirm button clicked");
        modalContainer.classList.remove('show');
        console.log("üì∏ Modal container class removed for confirm");
        if (onConfirm) {
          console.log("üì∏ About to call onConfirm");
          try {
            onConfirm();
            console.log("üì∏ onConfirm executed successfully");
          } catch (error) {
            console.error("‚ùå Error in onConfirm callback:", error.message);
          }
        }
      }, { once: true });
      console.log("üì∏ Binding cancel button listener");
      cancelBtn.addEventListener('click', () => {
        console.log("‚ùå Cancel button clicked");
        modalContainer.classList.remove('show');
        console.log("üì∏ Modal container class removed for cancel");
        if (onCancel) onCancel();
      }, { once: true });
    }

    function showPersistentMessage(message) {
      console.log("üì∏ Showing persistent message:", message);
      const modalContainer = document.getElementById('modal-container');
      if (!modalContainer) {
        console.error("‚ùå Modal container not found!");
        return;
      }
      modalContainer.innerHTML = `
        <div class="modal">
          <p style="white-space: pre-line;">${message}</p>
          <button id="ok-btn" class="btn btn-primary">OK</button>
        </div>
      `;
      modalContainer.classList.add('show');
      console.log("üì∏ Persistent message container class set to show");

      const okBtn = document.getElementById('ok-btn');
      if (!okBtn) {
        console.error("‚ùå OK button not found!");
        return;
      }
      okBtn.addEventListener('click', () => {
        console.log("‚úÖ OK button clicked");
        modalContainer.classList.remove('show');
      }, { once: true });
    }

    function showLoadingMessage(ticker) {
      console.log(`üì∏ Showing loading spinner for historical data: ${ticker}`);
      const modalContainer = document.getElementById('modal-container');
      if (!modalContainer) {
        console.error("‚ùå Modal container not found!");
        return;
      }
      modalContainer.innerHTML = `
        <div class="modal">
          <div class="spinner"></div>
          <p>Loading historical data for ${ticker}...</p>
        </div>
      `;
      modalContainer.classList.add('show');
      console.log("üì∏ Historical spinner container class set to show");
    }

    function showMetadataLoadingMessage() {
      console.log("üì∏ Entering showMetadataLoadingMessage");
      const modalContainer = document.getElementById('modal-container');
      if (!modalContainer) {
        console.error("‚ùå Modal container not found!");
        const newContainer = document.createElement('div');
        newContainer.id = 'modal-container';
        newContainer.style.display = 'none';
        document.body.appendChild(newContainer);
        console.log("üì∏ Created new modal-container");
        return showMetadataLoadingMessage();
      }
      modalContainer.innerHTML = `
        <div class="modal">
          <div class="spinner"></div>
          <p>Awaiting Metadata...</p>
        </div>
      `;
      modalContainer.classList.add('show');
      console.log("üì∏ Metadata spinner container class set to show");
      modalContainer.offsetHeight;
      console.log("üì∏ Forced DOM reflow for metadata spinner");
    }

    function hideLoadingMessage() {
      console.log("üì∏ Entering hideLoadingMessage");
      const modalContainer = document.getElementById('modal-container');
      if (!modalContainer) {
        console.error("‚ùå Modal container not found!");
        return;
      }
      modalContainer.classList.remove('show');
      console.log("üì∏ Loading spinner class removed");
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log("üì∏ DOMContentLoaded fired");
      const tickerForm = document.getElementById('ticker-form');
      const tickerInput = document.getElementById('ticker-input');
      const tickerList = document.getElementById('ticker-list');
      const feedback = document.getElementById('feedback');
      const modalContainer = document.getElementById('modal-container');

      if (!modalContainer) {
        console.error("‚ùå Modal container not found in DOM!");
        const newContainer = document.createElement('div');
        newContainer.id = 'modal-container';
